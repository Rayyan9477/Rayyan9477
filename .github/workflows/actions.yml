---
name: ğŸ”„ Unified GitHub Profile Update

# IMPORTANT: GitHub Secrets Configuration:
# 1. Go to your repository Settings > Secrets and variables > Actions
# 2. Add the following secrets:
#    - GH_TOKEN: Your GitHub Personal Access Token (optional - fallback)
#
# Required Permissions for Personal Access Token (if using GH_TOKEN):
# - repo (Full control of private repositories)
# - workflow (Update GitHub Action workflows)
# - read:user (Read user profile data)
# - user:email (Access user email addresses)

on:
  schedule:
    # Run every 12 hours for comprehensive updates
    - cron: '0 */12 * * *'  # Every 12 hours at 00:00 and 12:00 UTC
    # Additional daily run at 6:00 AM UTC for extra reliability
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [main]
    paths:
      - 'scripts/daily_update.py'
      - '.github/workflows/actions.yml'
      - 'README.md'

jobs:
  profile-update:
    name: ğŸ”„ GitHub Profile Update
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    env:
      # Use GitHub secrets for tokens - NEVER hardcode these values
      GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN || github.token }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for contribution snake

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git config --local pull.rebase false

      - name: ğŸ” Verify README Structure
        run: |
          echo "ğŸ” Checking README.md structure..."
          if grep -q "<!--START_SECTION:activity-->" README.md; then
            echo "âœ… Activity section found in README.md"
          else
            echo "âŒ Activity section missing from README.md"
            exit 1
          fi
          echo "âœ… README.md structure verification completed"

      - name: ğŸ Generate Contribution Snake
        uses: Platane/snk@v3
        continue-on-error: true
        with:
          github_user_name: "Rayyan9477"
          outputs: |
            assets/github-contribution-grid-snake.svg
            assets/github-contribution-grid-snake-dark.svg?palette=github-dark
            assets/github-contribution-grid-snake.gif?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9
            assets/github-contribution-grid-snake-rainbow.svg?palette=github-rainbow&color_snake=rainbow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ˆ Generate GitHub Activity
        if: github.event_name == 'schedule' ||
            github.event_name == 'workflow_dispatch'
        uses: jamesgeorge007/github-activity-readme@master
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          COMMIT_MSG: "ğŸ“Š Update GitHub activity stats - $(date +%Y-%m-%d)"
          MAX_LINES: 8
          GH_USERNAME: "Rayyan9477"
          TARGET_FILE: "README.md"
          COMMIT_NAME: "github-actions[bot]"
          COMMIT_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
          EMPTY_COMMIT_MSG: ":memo: empty commit to keep workflow active"
          SHOW_PRIVATE: false
          SHOW_COMMIT: true
          SHOW_ISSUE: true
          SHOW_PULL: true
          SHOW_RELEASE: true

      - name: ğŸ”„ Run GitHub Stats Updater
        run: |
          cd scripts
          if [ -f "github_stats_updater.py" ]; then
            echo "âœ… github_stats_updater.py found, executing..."
            python github_stats_updater.py
            echo "âœ… github_stats_updater.py execution completed"
          else
            echo "âŒ github_stats_updater.py not found in scripts directory"
            exit 1
          fi
          cd ..
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Run Daily Update Script
        run: |
          # Ensure README.md is accessible in scripts directory
          if [ -f "README.md" ]; then
            cp README.md scripts/README.md
            echo "âœ… README.md copied to scripts directory"
          else
            echo "âŒ README.md not found in root directory"
            exit 1
          fi
          cd scripts
          if [ -f "daily_update.py" ]; then
            echo "âœ… daily_update.py found, executing..."
            python daily_update.py
            echo "âœ… daily_update.py execution completed"
          else
            echo "âŒ daily_update.py not found in scripts directory"
            exit 1
          fi
          cd ..
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUSH_CHANGES: 'false'  # Don't push yet, we'll do one commit

      - name: ğŸ” Final README Verification
        run: |
          echo "ğŸ” Final README.md structure verification..."
          if grep -q "<!--START_SECTION:activity-->" README.md; then
            echo "âœ… Activity section still present in README.md"
          else
            echo "âŒ Activity section missing from README.md after updates"
            exit 1
          fi
          echo "âœ… Final README.md structure verification completed"

      - name: ğŸ’¾ Commit & Push All Changes
        run: |
          git add .
          git status
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ”„ Daily profile update - $(date +%Y-%m-%d)" \
              -m "ğŸ Updated contribution snake animations" \
              -m "ğŸ“Š Updated GitHub activity feed" \
              -m "ğŸ’¡ Added daily inspirational quote" \
              -m "ğŸ¤– Automated maintenance completed"
            git push
            echo "âœ… Successfully committed and pushed changes"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
        continue-on-error: true

      - name: Upload Logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: daily-update-logs
          path: |
            daily_update.log
            scripts/daily_update.log
          retention-days: 7

      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Daily update completed successfully!"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ• Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸš€ All systems operational!"

      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "ğŸ’¥ Daily update failed!"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ• Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ” Check the logs for more details"
          echo "âš ï¸ Troubleshooting: Verify GH_TOKEN"
