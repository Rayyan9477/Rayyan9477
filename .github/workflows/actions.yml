name: üîÑ Unified GitHub Profile Update

# IMPORTANT: GitHub Secrets Configuration:
# 1. Go to your repository Settings > Secrets and variables > Actions
# 2. Add the following secrets:
#    - GH_TOKEN: Your GitHub Personal Access Token (optional - fallback to github.token)
#    - WAKATIME_API_KEY: Your WakaTime API key from https://wakatime.com/settings/api-key
#
# Required Permissions for Personal Access Token (if using GH_TOKEN):
# - repo (Full control of private repositories)
# - workflow (Update GitHub Action workflows)
# - read:user (Read user profile data)
# - user:email (Access user email addresses)

on:
  schedule:
    # Run daily at 8:00 AM UTC
    - cron: '0 8 * * *'
    # Run every 12 hours for GitHub activity
    - cron: '0 */12 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'scripts/daily_update.py'
      - '.github/workflows/actions.yml'

jobs:
  profile-update:
    name: üîÑ GitHub Profile Update
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    env:
      # Use GitHub secrets for tokens - NEVER hardcode these values
      GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN || github.token }}
      WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for contribution snake
    
      - name:  Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
    
      - name:  Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
    
      - name:  Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git config --local pull.rebase false
    
      - name: üêç Generate Contribution Snake
        uses: Platane/snk@v3
        with:
          github_user_name: "Rayyan9477"
          outputs: |
            assets/github-contribution-grid-snake.svg
            assets/github-contribution-grid-snake-dark.svg?palette=github-dark
            assets/github-contribution-grid-snake.gif?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9
            assets/github-contribution-grid-snake-rainbow.svg?palette=github-rainbow&color_snake=rainbow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ‚è∞ Update WakaTime Stats
        uses: athul/waka-readme@master
        continue-on-error: true
        if: env.WAKATIME_API_KEY != ''
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: "Rayyan9477/Rayyan9477"
          SHOW_TITLE: true
          SECTION_NAME: " WakaTime Stats"
          BLOCKS: "programming"
          CODE_LANG: "text"
          TIME_RANGE: "last_7_days"
          LANG_COUNT: 6
          SHOW_TIME: true
          SHOW_TOTAL: true
          SHOW_MASKED_TIME: false
          STOP_AT_OTHER: true
          IGNORED_LANGUAGES: "Other"
          TARGET_BRANCH: "main"
          TARGET_PATH: "README.md"
          API_BASE_URL: "https://wakatime.com/api"
          COMMIT_MESSAGE: " Updated waka-readme graph with new metrics"
          COMMITTER_NAME: "GitHub Action"
          COMMITTER_EMAIL: "action@github.com"
          AUTHOR_NAME: "GitHub Action"
          AUTHOR_EMAIL: "action@github.com"

      - name: üìà Generate GitHub Activity
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: jamesgeorge007/github-activity-readme@master
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          COMMIT_MSG: "üìä Update GitHub activity stats"
          MAX_LINES: 5
          GH_USERNAME: "Rayyan9477"
          TARGET_FILE: "README.md"
          COMMIT_NAME: "github-actions[bot]"
          COMMIT_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
          EMPTY_COMMIT_MSG: ":memo: empty commit to keep workflow active after 60 days of no activity"
    
      - name: üîÑ Run Daily Update Script
        run: |
          # Ensure README.md is accessible in scripts directory
          if [ -f "README.md" ]; then
            cp README.md scripts/README.md
          fi
          cd scripts
          python daily_update.py
          cd ..
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          PUSH_CHANGES: 'false'  # Don't push yet, we'll do one commit
    
      - name: üíæ Commit & Push All Changes
        run: |
          git add .
          git status
          if ! git diff --staged --quiet; then
            git commit -m "üîÑ Daily profile update - $(date +%Y-%m-%d) 
            
            ‚Ä¢ üêç Updated contribution snake animations
            ‚Ä¢ ‚è∞ Refreshed WakaTime coding statistics  
            ‚Ä¢ üìä Updated GitHub activity feed
            ‚Ä¢ üí° Added daily inspirational quote
            ‚Ä¢ ü§ñ Automated maintenance completed"
            git push
            echo "‚úÖ Successfully committed and pushed changes"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi
        continue-on-error: true
    
      - name:  Upload Logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: daily-update-logs
          path: |
            daily_update.log
            scripts/daily_update.log
          retention-days: 7
    
      - name: ‚úÖ Success Notification
        if: success()
        run: |
          echo "üéâ Daily update completed successfully!"
          echo "üìÖ Date: $(date)"
          echo "üïê Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üöÄ All systems operational!"
    
      - name: ‚ùå Failure Notification
        if: failure()
        run: |
          echo "üí• Daily update failed!"
          echo "üìÖ Date: $(date)"
          echo "üïê Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üîç Check the logs for more details"
          echo "‚ö†Ô∏è Troubleshooting: Verify WAKATIME_API_KEY and GH_TOKEN secrets are set"
