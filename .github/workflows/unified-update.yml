name:  Unified Daily Profile Update

# IMPORTANT: GitHub Secrets Configuration:
# 1. Go to your repository Settings > Secrets and variables > Actions
# 2. Add the following secrets:
#    - WAKATIME_API_KEY: Your WakaTime API key from https://wakatime.com/settings/api-key

on:
  schedule:
    # Run daily at 8:00 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'scripts/daily_update.py'
      - '.github/workflows/unified-update.yml'

jobs:
  daily-update:
    name:  Daily GitHub Profile Update
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name:  Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for contribution snake
    
      - name:  Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
    
      - name:  Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
    
      - name:  Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git config --local pull.rebase false
    
      - name:  Generate Contribution Snake
        uses: Platane/snk@v3
        with:
          github_user_name: "Rayyan9477"
          outputs: |
            assets/github-contribution-grid-snake.svg
            assets/github-contribution-grid-snake-dark.svg?palette=github-dark
            assets/github-contribution-grid-snake.gif?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9
            assets/github-contribution-grid-snake-rainbow.svg?palette=github-rainbow&color_snake=rainbow
      
      - name:  Update WakaTime Stats
        uses: athul/waka-readme@master
        continue-on-error: true
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: "Rayyan9477/Rayyan9477"
          SHOW_TITLE: true
          SECTION_NAME: " WakaTime Stats"
          BLOCKS: "programming"
          CODE_LANG: "text"
          TIME_RANGE: "last_7_days"
          LANG_COUNT: 6
          SHOW_TIME: true
          SHOW_TOTAL: true
          SHOW_MASKED_TIME: false
          STOP_AT_OTHER: true
          IGNORED_LANGUAGES: "Other"
          TARGET_BRANCH: "main"
          TARGET_PATH: "README.md"
          API_BASE_URL: "https://wakatime.com/api"
          COMMIT_MESSAGE: " Updated waka-readme graph with new metrics"
          COMMITTER_NAME: "GitHub Action"
          COMMITTER_EMAIL: "action@github.com"
          AUTHOR_NAME: "GitHub Action"
          AUTHOR_EMAIL: "action@github.com"

      - name:  Generate GitHub Activity
        uses: jamesgeorge007/github-activity-readme@master
        with:
          GITHUB_TOKEN: ${{ github.token }}
          COMMIT_MSG: ' Update GitHub activity stats'
          MAX_LINES: 5
          GH_USERNAME: 'Rayyan9477'
          TARGET_FILE: 'README.md'
    
      - name:  Run Daily Update Script
        run: |
          # Ensure README.md is accessible in scripts directory
          if [ -f "README.md" ]; then
            cp README.md scripts/README.md
          fi
          cd scripts
          python daily_update.py
          cd ..
        env:
          GITHUB_TOKEN: ${{ github.token }}
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          PUSH_CHANGES: 'false'  # Don't push yet, we'll do one commit
    
      - name:  Commit & Push All Changes
        run: |
          git add .
          git status
          git diff --staged --quiet || git commit -m " Daily profile update - $(date +%Y-%m-%d)"
          git push
        continue-on-error: true
    
      - name:  Upload Logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: daily-update-logs
          path: |
            daily_update.log
            scripts/daily_update.log
          retention-days: 7
    
      - name:  Success Notification
        if: success()
        run: |
          echo " Daily update completed successfully!"
          echo " Date: $(date)"
          echo " Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
    
      - name:  Failure Notification
        if: failure()
        run: |
          echo " Daily update failed!"
          echo " Date: $(date)"
          echo " Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo " Check the logs for more details"
